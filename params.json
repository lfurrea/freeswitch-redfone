{"body":"### Introduction\r\n\r\nThis document summarizes the steps involved in setting up the fonebridge2 T1/E1 PRI-to-Ethernet Bridge with FreeSWITCH via the FreeTDM/libpri/DAHDI stack.\r\n\r\nFor this lab environment we used: \r\n\r\n####Linux Distro\r\nDebian Squeeze 6.0 \r\n2.6.32-5-amd64\r\n\r\n####FreesWITCH\r\nFreeSWITCH Version 1.2.0-rc2 \r\ncommit 7dc9a9cacc5366fb04748a89aa7556da8d68e57c\r\nDate:   Mon Jun 25 15:31:58 2012 -0500\r\n\r\n####DAHDI/Libpri\r\nDAHDI 2.4.1\r\nLibpri 1.4.12\r\n\r\n\r\nFreeTDM is a library that implements a high level API for handling I/O and telephony signaling for multiple boards and the fonebridge2 T1/E1 bridge terminations are no exception. \r\n\r\n####I/O Modules\r\n\r\nThe fonebridge2 uses the DAHDI interface and the DAHDI/IO module in FreeTDM (ftmod_zt) to read and write raw data from/to the board and the FreeTDM application, this module also achieves executing commands in the board.\r\n\r\n####Signaling Modules\r\n\r\nAs explained before the IO module does not interpret any telephony signaling going through and therefore a signaling module is required for this. This document uses the libpri module (ftmod_libpri) for the E1 PRI signaling but FreeTDM supports other PRI stacks as well as MFC-R2 for R2 signaling.\r\n\r\n### Installation\r\n\r\nFreeTDM is a library and as such can be installed alone, but in this document we consider its installation as part of the FreeSWITCH installation since it was born as a part of FreeSWITCH, and the source code is still part of the FreeSWITCH main repository.\r\n\r\n\r\n\r\n```\r\n$ cd /usr/local/src\r\n$ git clone git://git.freeswitch.org/freeswitch.git\r\n$ cd /usr/local/src/freeswitch\r\n```\r\nIf Git was used to download, the configuration files must be built before the first compile. Once this is performed it's not normally required to be performed again:\r\n\r\n```\r\n$ ./bootstrap.sh\r\n```\r\n\r\nThis creates many files including modules.conf, go ahead and uncomment the freetdm line in modules.conf\r\n\r\n```\r\n../../libs/freetdm/mod_freetdm\r\n```\r\n\r\n```\r\n$ ./configure\r\n$ make\r\n$ make install\r\n```\r\n\r\nIf you already have installed libpri the configure script will set things up so that ftmod_libpri is built, if you already have built your FreeSWITCH and are only building FreeTDM do as follows:\r\n\r\n```\r\n$ cd libs/freetdm\r\n$ ./configure --with-libpri --prefix=/usr/local/freeswitch\r\n$ make\r\n$ make install\r\n```\r\n\r\n### Configuration\r\n\r\n####The Library\r\n\r\nFirst we must configure the library (the freetdm library) which is done via a simple text file (not XML) located at _/usr/local/freeswitch/freetdm.conf_, when FreeTDM is installed as part of FreeSWITCH. This file configures the IO module and therefore it does not deal with any kind of telephony signaling parameters and we only configure which spans and channels to use, the trunk type, groups, audio gains. This may reflect the configurations you have on your /etc/dahdi/system.conf.\r\n\r\nAn example for a 4 E1 fonebridge2 board follows:\r\n\r\n```\r\n;ISDN PRI with DAHDI                                                                                                           \r\n[span zt FreeTDM1]\r\nname => firstcircuit\r\nnumber => 1\r\ntrunk_type => E1\r\nb-channel=1-15\r\nd-channel=16\r\nb-channel=17-31\r\n\r\n[span zt FreeTDM2]\r\nname => secondcircuit\r\nnumber => 2\r\ntrunk_type => E1\r\nb-channel=32-46\r\nd-channel=47\r\nb-channel=48-62\r\n\r\n[span zt FreeTDM3]\r\nname => thirdcircuit\r\nnumber => 3\r\ntrunk_type => E1\r\nb-channel=63-77\r\nd-channel=78\r\nb-channel=79-93\r\n\r\n[span zt FreeTDM4]\r\nname => fourthcircuit\r\nnumber => 4\r\ntrunk_type => E1\r\nb-channel=94-108\r\nd-channel=109\r\nb-channel=110-124\r\n```\r\n\r\n####The signaling\r\n\r\nAfter configuring the library we need to actually tell FreeSWITCH to use it and tell it which signaling settings to use and where to send the incoming calls to.\r\n\r\nThis is done via a typical FreeSWITCH XML configuration file located autoload_configs/freetdm.conf.xml\r\n\r\nWhich for our 4 E1 board will look like this:\r\n\r\n```\r\n<configuration name=\"freetdm.conf\" description=\"FreeTDM Configuration\">\r\n\r\n        <settings>\r\n                <param name=\"debug\" value=\"0\"/>\r\n                <!--<param name=\"hold-music\" value=\"$${moh_uri}\"/>-->\r\n                <!-- Analog global options (they apply to all spans)                                                           \r\n                     Remember you can only choose between either call-swap                                                     \r\n                     or 3-way, not both!                                                                                       \r\n                -->\r\n                <!--<param name=\"enable-analog-option\" value=\"call-swap\"/>-->\r\n                <!--<param name=\"enable-analog-option\" value=\"3-way\"/>-->\r\n                <!--                                                                                                           \r\n                Refuse to load the module if there is configuration errors                                                     \r\n                Defaults to 'no'                                                                                               \r\n                -->\r\n                <!--<param name=\"fail-on-error\" value=\"no\"/>-->\r\n        </settings>\r\n\r\n        <!-- Spans will be configured by the libpri module ftmod_libpri -->\r\n        <libpri_spans>\r\n                <span name=\"FreeTDM1\">\r\n                  <param name=\"node\" value=\"cpe\"/>\r\n                  <param name=\"switch\"   value=\"euroisdn\"/>\r\n                  <!-- <param name=\"opts\" value=\"omit_redirecting_number\"/> -->\r\n                  <!-- <param name=\"dp\" value=\"unknown\"/> -->\r\n                  <param name=\"debug\" value=\"none\"/>\r\n                  <!-- <param name=\"debug\"    value=\"q931_all\"/> -->\r\n                  <param name=\"dialplan\" value=\"XML\"/>\r\n                  <param name=\"context\" value=\"public\"/>\r\n                  <param name=\"l1\" value=\"alaw\"/>\r\n                </span>\r\n\r\n                <span name=\"FreeTDM2\">\r\n                  <param name=\"node\" value=\"cpe\"/>\r\n                  <param name=\"switch\"   value=\"euroisdn\"/>\r\n                  <!-- <param name=\"opts\" value=\"omit_redirecting_number\"/> -->\r\n                  <!-- <param name=\"dp\" value=\"unknown\"/> -->\r\n                  <param name=\"debug\" value=\"none\"/>\r\n                  <!-- <param name=\"debug\"    value=\"q931_all\"/> -->\r\n                  <param name=\"dialplan\" value=\"XML\"/>\r\n                  <param name=\"context\" value=\"public\"/>\r\n                  <param name=\"l1\" value=\"alaw\"/>\r\n </span>\r\n\r\n                <span name=\"FreeTDM3\">\r\n                  <param name=\"node\" value=\"cpe\"/>\r\n                  <param name=\"switch\"   value=\"euroisdn\"/>\r\n                  <!-- <param name=\"opts\" value=\"omit_redirecting_number\"/> -->\r\n                  <!-- <param name=\"dp\" value=\"unknown\"/> -->\r\n                  <param name=\"debug\" value=\"none\"/>\r\n                  <!-- <param name=\"debug\"    value=\"q931_all\"/> -->\r\n                  <param name=\"dialplan\" value=\"XML\"/>\r\n                  <param name=\"context\" value=\"public\"/>\r\n                  <param name=\"l1\" value=\"alaw\"/>\r\n                </span>\r\n\r\n                <span name=\"FreeTDM4\">\r\n                  <param name=\"node\" value=\"cpe\"/>\r\n                  <param name=\"switch\"   value=\"euroisdn\"/>\r\n                  <!-- <param name=\"opts\" value=\"omit_redirecting_number\"/> -->\r\n                  <!-- <param name=\"dp\" value=\"unknown\"/> -->\r\n                  <param name=\"debug\" value=\"none\"/>\r\n                  <!-- <param name=\"debug\"    value=\"q931_all\"/> -->\r\n                  <param name=\"dialplan\" value=\"XML\"/>\r\n                  <param name=\"context\" value=\"public\"/>\r\n                  <param name=\"l1\" value=\"alaw\"/>\r\n                </span>\r\n        </libpri_spans>\r\n</configuration>\r\n```\r\n\r\nWith this configuration Q931 call setup and digit collection will be handled via ftmod_libpri and you should see calls arrive within the public dialplan context.\r\n\r\nAssuming DID 1100 from your provider you could receive a test call as follows:\r\n\r\nconf/dialplan/public.xml\r\n```\r\n<extension name=\"public_pri_extension\">\r\n      <condition field=\"destination_number\" expression=\"^(1100)$\">\r\n        <action application=\"transfer\" data=\"$1 XML default\"/>\r\n      </condition>\r\n    </extension>\r\n```\r\n\r\nconf/dialplan/default.xml\r\n```\r\n<extension name=\"pri_test\">\r\n      <condition field=\"destination_number\" expression=\"^1100$\">\r\n        <action application=\"answer\"/>\r\n        <action application=\"sleep\" data=\"1000\"/>\r\n        <action application=\"playback\" data=\"voicemail/vm-goodbye.wav\"/>\r\n        <action application=\"sleep\" data=\"20000\"/>\r\n        <action application=\"hangup\"/>\r\n      </condition>\r\n    </extension>\r\n```\r\n\r\n### Support or Contact\r\nCheck out the documentation at http://support.red-fone.com/ or contact support@red-fone.com and weâ€™ll help you sort it out.","note":"Don't delete this file! It's used internally to help with page regeneration.","name":"freeswitch-redfone","google":"","tagline":"Freeswitch & Redfone Interoperability Documentation"}